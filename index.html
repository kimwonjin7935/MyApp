<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>whereIsMyCar (웹버전)</title>
<style>
  body, html {
    margin:0; padding:0; height:100vh; overflow:hidden;
    display:flex; flex-direction: column;
    font-family: Arial, sans-serif;
  }
  #buttons {
    padding: 10px; background: #333; display: flex; gap: 10px;
  }
  button {
    flex: 1; padding: 10px; color: #fff; background: #007bff;
    border: none; border-radius: 4px; font-size: 16px;
  }
  button:hover { background: #0056b3; }

  #container {
    position: relative; flex-grow: 1; background: #ccc;
    overflow: auto; touch-action: none;
  }
  #stage {
    position: relative;
    width: 100%; height: 100%;
  }
  #background {
    position: absolute; inset: 0; width: 100%; height: 100%;
    object-fit: contain; user-select: none; pointer-events: none;
  }
  #foreground {
    position: absolute; width: 150px; height: 150px;
    cursor: grab; user-select: none; display: none; touch-action: none;
  }
  #fg-resize-handle {
    position: absolute; width: 15px; height: 15px;
    background: rgba(0,0,0,.5); right: 0; bottom: 0;
    cursor: se-resize; display: none;
  }
  #zoomHud {
    position: fixed; right: 10px; bottom: 10px;
    background: rgba(0,0,0,.55); color: #fff; padding: 6px 10px;
    border-radius: 6px; font-size: 13px; z-index: 10; pointer-events: none;
  }
</style>
</head>
<body>

<div id="buttons">
  <button id="btnBg">배경사진등록및변경</button>
  <button id="btnFg">전경사진등록및변경</button>
</div>

<div id="container">
  <div id="stage">
    <img id="background" src="" alt="배경이미지" />
    <img id="foreground" src="" alt="전경이미지" draggable="false" />
    <div id="fg-resize-handle"></div>
  </div>
</div>

<div id="zoomHud">100%</div>

<input type="file" id="inputBg" accept="image/*" style="display:none;" />
<input type="file" id="inputFg" accept="image/*" style="display:none;" />

<script>
const container = document.getElementById('container');
const stage = document.getElementById('stage');
const bg = document.getElementById('background');
const fg = document.getElementById('foreground');
const fgHandle = document.getElementById('fg-resize-handle');
const zoomHud = document.getElementById('zoomHud');
const btnBg = document.getElementById('btnBg');
const btnFg = document.getElementById('btnFg');
const inputBg = document.getElementById('inputBg');
const inputFg = document.getElementById('inputFg');

let baseW = 0, baseH = 0;
let scale = 1;
const STEP = 1.1;
const MIN_SCALE = 0.25, MAX_SCALE = 8;

const fgState = {x:0, y:0, w:150, h:150, visible:false};
const clamp = (v,a,b)=>Math.min(Math.max(v,a),b);

/* === 공통 유틸 === */
function computeBaseSize(){
  const cw = container.clientWidth, ch = container.clientHeight;
  if (bg.naturalWidth && bg.naturalHeight){
    const s = Math.min(cw/bg.naturalWidth, ch/bg.naturalHeight);
    baseW = bg.naturalWidth*s; baseH = bg.naturalHeight*s;
  } else { baseW=cw; baseH=ch; }
}
function applyStageSize(){
  stage.style.width = (baseW*scale)+"px";
  stage.style.height= (baseH*scale)+"px";
  syncFgVisual();
}
function syncFgVisual(){
  if(!fgState.visible) return;
  fg.style.display='block'; fgHandle.style.display='block';
  fg.style.left = (fgState.x*scale)+"px";
  fg.style.top  = (fgState.y*scale)+"px";
  fg.style.width= (fgState.w*scale)+"px";
  fg.style.height=(fgState.h*scale)+"px";
}
function screenToLogical(clientX, clientY){
  const rect = container.getBoundingClientRect();
  return {
    lx: (container.scrollLeft + (clientX-rect.left))/scale,
    ly: (container.scrollTop  + (clientY-rect.top ))/scale
  };
}

/* === 배경 확대 === */
function applyStageScale(next, anchor){
  next = clamp(next, MIN_SCALE, MAX_SCALE);
  const prev = scale;
  if(anchor){
    const rect = container.getBoundingClientRect();
    const ax = container.scrollLeft+(anchor.clientX-rect.left);
    const ay = container.scrollTop +(anchor.clientY-rect.top);
    scale=next; applyStageSize();
    const ratio = scale/prev;
    container.scrollLeft = ax*ratio - (anchor.clientX-rect.left);
    container.scrollTop  = ay*ratio - (anchor.clientY-rect.top);
  } else { scale=next; applyStageSize(); }
  zoomHud.textContent=Math.round(scale*100)+'%';
}

/* === 전경 확대 === */
function resizeForegroundByFactor(factor, anchorLogical){
  if(!fgState.visible) return;
  let newW=clamp(fgState.w*factor,20,baseW);
  let newH=clamp(fgState.h*factor,20,baseH);
  const ax = clamp(anchorLogical.lx, fgState.x, fgState.x+fgState.w);
  const ay = clamp(anchorLogical.ly, fgState.y, fgState.y+fgState.h);
  const relX=(ax-fgState.x)/fgState.w, relY=(ay-fgState.y)/fgState.h;
  let newX=ax-relX*newW, newY=ay-relY*newH;
  newX=clamp(newX,0,baseW-newW); newY=clamp(newY,0,baseH-newH);
  fgState.x=newX; fgState.y=newY; fgState.w=newW; fgState.h=newH;
  syncFgVisual();
}

/* === 전경 드래그 (논리 좌표 기준) === */
let dragging=false, dragDX=0, dragDY=0;
function startDrag(e){
  if(!fgState.visible) return;
  dragging=true;
  const p=e.touches?e.touches[0]:e;
  const {lx,ly}=screenToLogical(p.clientX,p.clientY);
  dragDX=lx-fgState.x; dragDY=ly-fgState.y;
  fg.style.cursor='grabbing';
}
function dragMove(e){
  if(!dragging) return;
  e.preventDefault();
  const p=e.touches?e.touches[0]:e;
  const {lx,ly}=screenToLogical(p.clientX,p.clientY);
  let nx=lx-dragDX, ny=ly-dragDY;
  nx=clamp(nx,0,baseW-fgState.w);
  ny=clamp(ny,0,baseH-fgState.h);
  fgState.x=nx; fgState.y=ny;
  syncFgVisual();
}
function stopDrag(){ dragging=false; fg.style.cursor='grab'; }

fg.addEventListener('mousedown', startDrag);
fg.addEventListener('touchstart', startDrag,{passive:false});
window.addEventListener('mousemove', dragMove,{passive:false});
window.addEventListener('touchmove', dragMove,{passive:false});
window.addEventListener('mouseup', stopDrag);
window.addEventListener('touchend', stopDrag);

/* === 전경 리사이즈 핸들 === */
let resizing=false;
fgHandle.addEventListener('mousedown',e=>{e.stopPropagation();resizing=true;});
window.addEventListener('mousemove',e=>{
  if(!resizing) return; e.preventDefault();
  let newW=(e.clientX-fg.getBoundingClientRect().left)/scale;
  let newH=(e.clientY-fg.getBoundingClientRect().top )/scale;
  fgState.w=clamp(newW,20,baseW-fgState.x);
  fgState.h=clamp(newH,20,baseH-fgState.y);
  syncFgVisual();
},{passive:false});
window.addEventListener('mouseup',()=>{resizing=false;});

/* === 확대 입력 === */
container.addEventListener('wheel',e=>{
  if(e.ctrlKey){
    if(e.target===fg) return; // 전경 휠은 별도
    e.preventDefault();
    applyStageScale(scale*(e.deltaY>0?1/STEP:STEP),{clientX:e.clientX,clientY:e.clientY});
  }
},{passive:false});
fg.addEventListener('wheel',e=>{
  if(!e.ctrlKey) return;
  e.preventDefault();
  resizeForegroundByFactor(e.deltaY>0?1/STEP:STEP,screenToLogical(e.clientX,e.clientY));
},{passive:false});

/* === 파일 로드 === */
btnBg.onclick=()=>inputBg.click();
btnFg.onclick=()=>inputFg.click();
inputBg.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  bg.src=URL.createObjectURL(f);
  bg.onload=()=>{ computeBaseSize(); applyStageSize(); };
};
inputFg.onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  fg.src=URL.createObjectURL(f);
  fg.onload=()=>{
    fgState.w=150; fgState.h=150;
    fgState.x=(baseW-150)/2; fgState.y=(baseH-150)/2;
    fgState.visible=true; syncFgVisual();
  };
};

/* === 초기화 === */
window.addEventListener('load',()=>{
  computeBaseSize(); applyStageSize();
});
window.addEventListener('resize',()=>{
  computeBaseSize(); applyStageSize();
});
</script>
</body>
</html>
